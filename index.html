<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="data/ticker-mapping.js"></script>
</head>
<body>
    <div class="container">
        <h1>Portfolio Management System</h1>
        
        <div class="section">
            <h2>Import Avanza CSV</h2>
            <input type="file" id="csvFileInput" accept=".csv" />
            <button id="importBtn" onclick="importCSV()">Import Portfolio Data</button>
            <button onclick="savePortfolioToSupabase()" style="margin: 5px;">Save Portfolio to Database</button>
            <button onclick="loadPortfolioFromSupabase()" style="margin: 5px;">Load Portfolio from Database</button>
        </div>
        
       <div class="section">
            <h2>Portfolio Data</h2>
            <div id="portfolioData">
                <p>No data imported yet. Please select and import a CSV file.</p>
            </div>
        </div>
        
        <div class="section">
            <h2>Account Selection</h2>
            <div id="accountSelection">
                <p>Import CSV data first to see accounts.</p>
            </div>
        </div>
        
        <div class="section">
            <h2>Aggregated Portfolio View</h2>
            <div id="aggregatedView">
                <p>Select accounts and ensure tickers are mapped to see aggregated view.</p>
            </div>
        </div>
        
        <div class="section">
            <h2>Currency & Price Updates</h2>
            <div id="currencyControls">
                <button onclick="fetchExchangeRates()" style="margin: 5px;">Update Exchange Rates</button>
                <button onclick="fetchStockPrices()" style="margin: 5px;">Fetch Current Stock Prices</button>
                <button onclick="savePortfolioSnapshot()" style="margin: 5px;">Save Daily Portfolio Snapshot</button>
                <div id="exchangeRateStatus">
                    <p>Click "Update Exchange Rates" to fetch current rates.</p>
                </div>
            </div>
        </div>
    </div>
      
<script>
// Updated: 2024-09-28-20:45 - Cache buster
// Supabase configuration
const SUPABASE_URL = 'https://zdobzwylyeonigdcsohv.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpkb2J6d3lseWVvbmlnZGNzb2h2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwODQ1MjgsImV4cCI6MjA3NDY2MDUyOH0.pFR1IYyu_uU1dGD363eeyyTVcAk2H7wHeYE-YSQoSMI'
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Portfolio Manager - Minimal Working Version
console.log('Portfolio Manager starting...');

let portfolioData = [];
let tickerMapping = window.TICKER_MAPPING || {};

// Load ticker mapping
function loadTickerMapping() {
    tickerMapping = window.TICKER_MAPPING || {};
    console.log('Ticker mapping loaded:', Object.keys(tickerMapping).length, 'mappings');
}

// Convert Ticker function
function convertTicker(avanzaTicker) {
    if (!avanzaTicker || avanzaTicker === '') return '';
    if (tickerMapping[avanzaTicker]) {
        return tickerMapping[avanzaTicker];
    }
    return avanzaTicker;
}

    // Account selection variables and functions
let selectedAccounts = new Set();

function displayAccountSelection() {
    const container = document.getElementById('accountSelection');
    
    if (portfolioData.length === 0) {
        container.innerHTML = '<p>Import CSV data first to see accounts.</p>';
        return;
    }
    
    const accounts = [...new Set(portfolioData.map(row => row['Kontonummer']).filter(acc => acc))];
    
    if (selectedAccounts.size === 0) {
        accounts.forEach(acc => selectedAccounts.add(acc));
    }
    
    let html = '<p>Select accounts to include in analysis:</p>';
    
    accounts.forEach(account => {
        const isChecked = selectedAccounts.has(account);
        html += `
            <label style="display: block; margin: 5px 0;">
                <input type="checkbox" ${isChecked ? 'checked' : ''} 
                       onchange="toggleAccount('${account}')" />
                Account: ${account}
            </label>
        `;
    });
    
   html += '<br><button onclick="updateAggregatedView()" style="margin-top: 10px;">Update Aggregated View</button>';
    
    container.innerHTML = html;
}

function toggleAccount(accountNumber) {
    if (selectedAccounts.has(accountNumber)) {
        selectedAccounts.delete(accountNumber);
    } else {
        selectedAccounts.add(accountNumber);
    }
}

function updateAggregatedView() {
    const container = document.getElementById('aggregatedView');
    
    if (portfolioData.length === 0 || selectedAccounts.size === 0) {
        container.innerHTML = '<p>Select accounts and ensure data is imported to see aggregated view.</p>';
        return;
    }
    
    // Filter data by selected accounts and exclude funds
    const filteredData = portfolioData.filter(row => {
        const account = row['Kontonummer'];
        const type = row['Typ'];
        return selectedAccounts.has(account) && type !== 'FUND';
    });
    
    // Group by Yahoo ticker
    const aggregated = {};
    
    filteredData.forEach(row => {
        const avanzaTicker = row['Kortnamn'] || '';
        const yahooTicker = convertTicker(avanzaTicker);
        const volume = parseFloat(row['Volym']) || 0;
        const marketValue = parseFloat(row['Marknadsvärde'].replace(',', '.')) || 0;
        const currency = row['Valuta'] || '';
        const name = row['Namn'] || '';
        
        if (!yahooTicker || yahooTicker === '') return;
        
        if (!aggregated[yahooTicker]) {
            aggregated[yahooTicker] = {
                name: name,
                ticker: yahooTicker,
                totalVolume: 0,
                totalValue: 0,
                currency: currency,
                accounts: new Set()
            };
        }
        
        aggregated[yahooTicker].totalVolume += volume;
        aggregated[yahooTicker].totalValue += marketValue;
        aggregated[yahooTicker].accounts.add(row['Kontonummer']);
    });
    
    // Convert to array and sort by value
    const sortedStocks = Object.values(aggregated).sort((a, b) => b.totalValue - a.totalValue);
    
    let html = `<p>Aggregated view for ${selectedAccounts.size} selected accounts:</p>`;
    html += '<table border="1" style="width:100%; border-collapse: collapse;">';
    html += '<tr><th>Stock Name</th><th>Yahoo Ticker</th><th>Total Volume</th><th>Total Value</th><th>Currency</th><th>Accounts</th></tr>';
    
    let totalPortfolioValue = 0;
    
    sortedStocks.forEach(stock => {
        totalPortfolioValue += stock.totalValue;
        html += `<tr>
            <td>${stock.name}</td>
            <td>${stock.ticker}</td>
            <td>${stock.totalVolume.toLocaleString()}</td>
            <td>${stock.totalValue.toLocaleString()} ${stock.currency}</td>
            <td>${stock.currency}</td>
            <td>${Array.from(stock.accounts).join(', ')}</td>
        </tr>`;
    });
    
    html += '</table>';
    html += `<p><strong>Total Portfolio Value: ${totalPortfolioValue.toLocaleString()} (mixed currencies)</strong></p>`;
    
    container.innerHTML = html;
}
    
// Import CSV function
function importCSV() {
    const fileInput = document.getElementById('csvFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a CSV file first!');
        return;
    }
    
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvContent = e.target.result;
        parseCSV(csvContent);
    };
    reader.readAsText(file);
}
    

    
// Parse CSV
function parseCSV(csvContent) {
    try {
        const lines = csvContent.split('\n');
        const headers = lines[0].split(';');
        portfolioData = [];
        
        for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            const values = lines[i].split(';');
            const row = {};
            headers.forEach((header, index) => {
                row[header.trim()] = values[index] ? values[index].trim() : '';
            });
            portfolioData.push(row);
        }
        
        displayBasicData();
        console.log('Imported', portfolioData.length, 'holdings');
        
    } catch (error) {
        alert('Error parsing CSV: ' + error.message);
    }
}

// Enhanced display with editable ticker mapping
function displayBasicData() {
    const container = document.getElementById('portfolioData');
    let html = `<p>Successfully imported ${portfolioData.length} holdings!</p>`;
    html += '<table border="1" style="width:100%; border-collapse: collapse;">';
    html += '<tr><th>Account</th><th>Name</th><th>Avanza Ticker</th><th>Yahoo Ticker</th><th>Volume</th><th>Value</th><th>Currency</th><th>Action</th></tr>';
    
    portfolioData.forEach((row, index) => {
        const avanzaTicker = row['Kortnamn'] || '';
        const yahooTicker = convertTicker(avanzaTicker);
        const stockType = row['Typ'] || '';
        
        if (stockType === 'FUND') {
            html += `<tr style="background-color: #f8f9fa; color: #6c757d;">
                <td>${row['Kontonummer'] || ''}</td>
                <td>${row['Namn'] || ''}</td>
                <td>${avanzaTicker}</td>
                <td><em>Fund</em></td>
                <td>${row['Volym'] || ''}</td>
                <td>${row['Marknadsvärde'] || ''}</td>
                <td>${row['Valuta'] || ''}</td>
                <td><em>-</em></td>
            </tr>`;
        } else {
            const hasMapping = tickerMapping[avanzaTicker] !== undefined;
            const needsMapping = !hasMapping && avanzaTicker !== '';
            
            html += `<tr ${needsMapping ? 'style="background-color: #fff3cd;"' : ''}>
                <td>${row['Kontonummer'] || ''}</td>
                <td>${row['Namn'] || ''}</td>
                <td>${avanzaTicker}</td>
                <td>
                    <input type="text" id="ticker_${index}" value="${yahooTicker}" 
                           style="width: 100px; ${needsMapping ? 'border: 2px solid orange;' : ''}" />
                </td>
                <td>${row['Volym'] || ''}</td>
                <td>${row['Marknadsvärde'] || ''}</td>
                <td>${row['Valuta'] || ''}</td>
                <td>
                    <button onclick="saveTicker(${index}, '${avanzaTicker}')" 
                            style="font-size: 12px; padding: 5px;">Save</button>
                </td>
            </tr>`;
        }
    });
    
    html += '</table>';
    html += '<p><strong>Note:</strong> Yellow rows need ticker mapping. Orange borders indicate unmapped tickers.</p>';
    container.innerHTML = html;
    displayAccountSelection();
}

// Save ticker mapping
function saveTicker(rowIndex, avanzaTicker) {
    const newYahooTicker = document.getElementById(`ticker_${rowIndex}`).value.trim();
    
    if (!newYahooTicker) {
        alert('Please enter a valid ticker');
        return;
    }
    
    // Update the in-memory mapping
    tickerMapping[avanzaTicker] = newYahooTicker;
    console.log('Saved mapping:', avanzaTicker, '->', newYahooTicker);
    
    alert(`Mapping saved: ${avanzaTicker} -> ${newYahooTicker}`);
    
    // Refresh the display
    displayBasicData();
}

    // Save current portfolio snapshot to Supabase
async function savePortfolioSnapshot() {
    if (portfolioData.length === 0 || selectedAccounts.size === 0) {
        alert('Please import portfolio data and select accounts first');
        return;
    }
    
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
    const totalValue = calculateCurrentTotalValue();
    
    try {
        const { data, error } = await supabase
            .from('portfolio_snapshots')
            .insert([{
                date: today,
                total_value_sek: totalValue,
                notes: `${portfolioData.length} holdings, ${selectedAccounts.size} accounts`
            }]);
            
        if (error) throw error;
        
        alert(`Portfolio snapshot saved for ${today}: ${totalValue.toLocaleString()} SEK`);
        
    } catch (error) {
        console.error('Error saving snapshot:', error);
        alert('Error saving snapshot: ' + error.message);
    }
}

    // Save portfolio holdings to Supabase
async function savePortfolioToSupabase() {
    if (portfolioData.length === 0) {
        alert('Please import CSV data first');
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    try {
        
// First, delete old holdings (optional - or keep history)
        await supabase
            .from('portfolio_holdings')
            .delete()
            .gte('id', 0); // Delete all rows
        
        // Prepare holdings data
        const holdings = portfolioData.map(row => ({
            account_number: row['Kontonummer'],
            name: row['Namn'],
            avanza_ticker: row['Kortnamn'],
            yahoo_ticker: convertTicker(row['Kortnamn']),
            volume: parseFloat(row['Volym']) || 0,
            market_value: parseFloat(row['Marknadsvärde'].replace(',', '.')) || 0,
            currency: row['Valuta'],
            type: row['Typ'],
            import_date: today,
            isin: row['ISIN']
        }));
        
        // Insert new holdings
        const { data, error } = await supabase
            .from('portfolio_holdings')
            .insert(holdings);
            
        if (error) throw error;
        
        alert(`Saved ${holdings.length} holdings to database for ${today}`);
        
    } catch (error) {
        console.error('Error saving portfolio:', error);
        alert('Error saving portfolio: ' + error.message);
    }
}

// Load portfolio holdings from Supabase
async function loadPortfolioFromSupabase() {
    try {
        const { data, error } = await supabase
            .from('portfolio_holdings')
            .select('*')
            .order('import_date', { ascending: false })
            .limit(200); // Get latest import
            
        if (error) throw error;
        
        if (!data || data.length === 0) {
            alert('No saved portfolio data found. Please import CSV first.');
            return;
        }
        
        // Convert Supabase data back to portfolioData format
        portfolioData = data.map(row => ({
            'Kontonummer': row.account_number,
            'Namn': row.name,
            'Kortnamn': row.avanza_ticker,
            'Volym': row.volume.toString(),
            'Marknadsvärde': row.market_value.toString(),
            'Valuta': row.currency,
            'Typ': row.type,
            'ISIN': row.isin
        }));
        
        displayBasicData();
        console.log(`Loaded ${portfolioData.length} holdings from database`);
        alert(`Loaded ${portfolioData.length} holdings from ${data[0].import_date}`);
        
    } catch (error) {
        console.error('Error loading portfolio:', error);
        alert('Error loading portfolio: ' + error.message);
    }
}
    
// Calculate total portfolio value (reuse aggregation logic)
function calculateCurrentTotalValue() {
    const filteredData = portfolioData.filter(row => {
        const account = row['Kontonummer'];
        const type = row['Typ'];
        return selectedAccounts.has(account) && type !== 'FUND';
    });
    
    let total = 0;
    filteredData.forEach(row => {
        const marketValue = parseFloat(row['Marknadsvärde'].replace(',', '.')) || 0;
        total += marketValue;
    });
    
    return total;
}

    
// Placeholder functions
function fetchExchangeRates() {
    alert('Exchange rates - coming next!');
}

function fetchStockPrices() {
    alert('Stock prices - coming next!');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Portfolio Manager loaded successfully!');
    loadTickerMapping();
});
</script>
