<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Manager</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <h1>Portfolio Management System</h1>
        
        <div class="section">
            <h2>Import Avanza CSV</h2>
            <input type="file" id="csvFileInput" accept=".csv" />
            <button id="importBtn" onclick="importCSV()">Import Portfolio Data</button>
        </div>
        
       <div class="section">
            <h2>Portfolio Data</h2>
            <div id="portfolioData">
                <p>No data imported yet. Please select and import a CSV file.</p>
            </div>
        </div>
        
        <div class="section">
            <h2>Account Selection</h2>
            <div id="accountSelection">
                <p>Import CSV data first to see accounts.</p>
            </div>
        </div>
        
        <div class="section">
            <h2>Aggregated Portfolio View</h2>
            <div id="aggregatedView">
                <p>Select accounts and ensure tickers are mapped to see aggregated view.</p>
            </div>
        </div>
        
        <div class="section">
            <h2>Currency & Price Updates</h2>
            <div id="currencyControls">
                <button onclick="fetchExchangeRates()" style="margin: 5px;">Update Exchange Rates</button>
                <button onclick="fetchStockPrices()" style="margin: 5px;">Fetch Current Stock Prices</button>
                <div id="exchangeRateStatus">
                    <p>Click "Update Exchange Rates" to fetch current rates.</p>
                </div>
            </div>
        </div>
    </div>
      
<script>
// Updated: 2024-09-28-14:35 - Cache buster
// Portfolio Manager - Minimal Working Version
console.log('Portfolio Manager starting...');

let portfolioData = [];
let tickerMapping = {};

// Load ticker mapping
async function loadTickerMapping() {
    try {
        const response = await fetch('data/ticker-mapping.json');
        tickerMapping = await response.json();
        console.log('Ticker mapping loaded:', Object.keys(tickerMapping).length, 'mappings');
    } catch (error) {
        console.error('Error loading ticker mapping:', error);
        tickerMapping = {};
    }
}

// Import CSV function
function importCSV() {
    const fileInput = document.getElementById('csvFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a CSV file first!');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvContent = e.target.result;
        parseCSV(csvContent);
    };
    reader.readAsText(file);
}

// Parse CSV
function parseCSV(csvContent) {
    try {
        const lines = csvContent.split('\n');
        const headers = lines[0].split(';');
        portfolioData = [];
        
        for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            const values = lines[i].split(';');
            const row = {};
            headers.forEach((header, index) => {
                row[header.trim()] = values[index] ? values[index].trim() : '';
            });
            portfolioData.push(row);
        }
        
        displayBasicData();
        console.log('Imported', portfolioData.length, 'holdings');
        
    } catch (error) {
        alert('Error parsing CSV: ' + error.message);
    }
}

// Basic display
function displayBasicData() {
    const container = document.getElementById('portfolioData');
    let html = `<p>Successfully imported ${portfolioData.length} holdings!</p>`;
    html += '<table border="1" style="width:100%; border-collapse: collapse;">';
    html += '<tr><th>Account</th><th>Name</th><th>Ticker</th><th>Volume</th><th>Value</th><th>Currency</th></tr>';
    
    portfolioData.forEach(row => {
        html += `<tr>
            <td>${row['Kontonummer'] || ''}</td>
            <td>${row['Namn'] || ''}</td>
            <td>${row['Kortnamn'] || ''}</td>
            <td>${row['Volym'] || ''}</td>
            <td>${row['Marknadsv√§rde'] || ''}</td>
            <td>${row['Valuta'] || ''}</td>
        </tr>`;
    });
    
    html += '</table>';
    container.innerHTML = html;
}

// Placeholder functions
function fetchExchangeRates() {
    alert('Exchange rates - coming next!');
}

function fetchStockPrices() {
    alert('Stock prices - coming next!');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Portfolio Manager loaded successfully!');
    loadTickerMapping();
});
</script>
